<!DOCTYPE html>
<html>
<head>
    <title>6G Fabric Network</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        svg { border: 1px solid #ccc; }
        .node { stroke: #000; stroke-width: 1.5px; }
        .link { stroke: #999; stroke-opacity: 0.6; }
        select, button, input { margin: 10px; }
    </style>
</head>
<body>
    <h1>6G Fabric Network Visualization</h1>
    <label for="orgCount">Number of Organizations:</label>
    <input type="number" id="orgCount" min="1" value="8">
    <button onclick="setOrgCount()">Set Organization Count</button>
    <br>
    <select id="contractSelect"></select>
    <select id="orgSelect"></select>
    <button onclick="fetchAndDraw()">Load Data</button>
    <svg width="800" height="600"></svg>
    <script>
        async function populateContracts() {
            const response = await fetch('/contracts');
            const { contracts } = await response.json();
            const select = document.getElementById('contractSelect');
            select.innerHTML = '';
            contracts.forEach(contract => {
                const option = document.createElement('option');
                option.value = contract;
                option.text = contract;
                select.appendChild(option);
            });
        }

        async function populateOrgSelect() {
            const response = await fetch('/org-count');
            const { orgCount } = await response.json();
            const select = document.getElementById('orgSelect');
            select.innerHTML = '';
            for (let i = 1; i <= orgCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `Org${i}`;
                select.appendChild(option);
            }
        }

        async function setOrgCount() {
            const orgCount = document.getElementById('orgCount').value;
            const response = await fetch('/set-org-count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orgCount })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(result.message);
                await populateOrgSelect();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function fetchNetworkData() {
            const contractName = document.getElementById('contractSelect').value;
            const orgNumber = document.getElementById('orgSelect').value;
            const channelMap = {
                'AssetManagement': 'NetworkChannel', 'UserManagement': 'NetworkChannel',
                'IoTManagement': 'NetworkChannel', 'AntennaManagement': 'NetworkChannel',
                'NetworkManagement': 'NetworkChannel', 'ResourceManagement': 'NetworkChannel',
                'PerformanceManagement': 'NetworkChannel', 'SessionManagement': 'NetworkChannel',
                'PolicyManagement': 'NetworkChannel', 'ManageNetwork': 'NetworkChannel',
                'ManageAntenna': 'NetworkChannel', 'ManageIoTDevice': 'NetworkChannel',
                'ManageUser': 'NetworkChannel',
                'LocationBased': 'ResourceChannel',
                'Authenticate': 'AuthChannel', 'Register': 'AuthChannel', 'Revoke': 'AuthChannel',
                'AssignRole': 'AuthChannel', 'Connect': 'ConnectivityChannel',
                'Monitor': 'AuditChannel', 'Log': 'AuditChannel',
                'EncryptData': 'SecurityChannel', 'DecryptData': 'SecurityChannel',
                'SecureCommunication': 'SecurityChannel', 'VerifyIdentity': 'SecurityChannel',
                'SetPolicy': 'SecurityChannel', 'GetPolicy': 'SecurityChannel',
                'UpdatePolicy': 'SecurityChannel', 'LogPolicyAudit': 'SecurityChannel'
            };
            const channel = Object.keys(channelMap).find(key => contractName.includes(key)) ? channelMap[Object.keys(channelMap).find(key => contractName.includes(key))] : 'DataChannel';
            const response = await fetch(`/query?channelName=${channel}&contractName=${contractName}&functionName=QueryAllAssets&orgNumber=${orgNumber}&args=[]`);
            const data = await response.json();
            return data.result.map(item => ({
                id: item.deviceID || item.userID || item.networkID || item.entityID || item.policyID || item.antennaID || item.assetID || item.id || 'unknown',
                x: item.latitude ? parseFloat(item.latitude) : Math.random() * 800,
                y: item.longitude ? parseFloat(item.longitude) : Math.random() * 600,
                type: item.deviceID ? 'iot' : item.userID ? 'user' : 'other'
            }));
        }

        async function fetchAndDraw() {
            const nodes = await fetchNetworkData();
            const links = nodes.map((node, i) => ({
                source: node.id,
                target: nodes[(i + 1) % nodes.length].id
            }));

            const svg = d3.select('svg');
            svg.selectAll('*').remove();
            const width = +svg.attr('width');
            const height = +svg.attr('height');

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id))
                .force('charge', d3.forceManyBody().strength(-50))
                .force('center', d3.forceCenter(width / 2, height / 2));

            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link');

            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('class', 'node')
                .attr('r', 5)
                .attr('fill', d => d.type === 'iot' ? 'blue' : d.type === 'user' ? 'green' : 'red');

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });
        }

        populateContracts();
        populateOrgSelect();
    </script>
</body>
</html>
